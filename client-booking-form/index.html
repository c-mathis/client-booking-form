<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Your Appointment</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f4f4f4;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
    }

    form {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    label {
      display: block;
      margin: 1rem 0 0.25rem;
      font-weight: bold;
    }

    input,
    select {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .slot {
      padding: 0.75rem;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
    }

    .slot.selected {
      background: #0070f3;
      color: white;
      font-weight: bold;
    }

    button {
      background: #0070f3;
      color: white;
      border: none;
      padding: 1rem;
      width: 100%;
      border-radius: 4px;
      font-size: 1rem;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Book Your Appointment</h1>

  <form id="booking-form" method="POST" action="https://appointment-worker.cameron-07f.workers.dev/">
    <label for="name">Your Name</label>
    <input type="text" name="name" id="name" required />

    <label for="email">Your Email</label>
    <input type="email" name="email" id="email" required />

    <label for="phone">Phone Number</label>
    <input type="tel" name="phone" id="phone" />

    <label for="date">Select a Day</label>
    <input type="date" id="date" required />

    <label>Pick a Time</label>
    <div id="times" class="grid"></div>

    <input type="hidden" name="selectedTime" id="selectedTime" />
    <input type="hidden" name="caseManagerEmail" id="caseManagerEmail" />

    <button type="submit">Book Appointment</button>
  </form>

  <script>
    const params = new URLSearchParams(window.location.search);
    const cm = params.get("cm");
    if (cm) {
      document.getElementById("caseManagerEmail").value = cm;
    }

    const timesDiv = document.getElementById("times");
    const dateInput = document.getElementById("date");
    const selectedTimeInput = document.getElementById("selectedTime");

    const today = new Date().toISOString().split("T")[0];
    dateInput.setAttribute("min", today);

    let availableTimes = [];

    dateInput.addEventListener("change", async () => {
      const selectedDate = dateInput.value;
      console.log("Date changed:", selectedDate, "CM:", cm);
      if (!selectedDate || !cm) {
        console.log("Missing date or CM, returning");
        return;
      }

      timesDiv.innerHTML = "<em>Loading...</em>";
      const response = await fetch(
        `https://appointment-worker.cameron-07f.workers.dev/availability?cm=${encodeURIComponent(cm)}`
      );
      const data = await response.json();
      console.log("Busy slots:", data.busy);

      const busyRanges = data.busy.map((b) => ({
        start: new Date(b.start),
        end: new Date(b.end),
      }));

      const dayStart = new Date(`${selectedDate}T08:00:00`);
      const slots = [];

      for (let h = 8; h < 17; h++) {
        for (let m = 0; m < 60; m += 30) {
          const slot = new Date(selectedDate + `T${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:00`);
          if (slot <= new Date()) continue;

          const isBusy = busyRanges.some(
            (range) => slot >= range.start && slot < range.end
          );

          if (!isBusy) {
            // Create timezone-neutral datetime string
            const year = slot.getFullYear();
            const month = String(slot.getMonth() + 1).padStart(2, '0');
            const day = String(slot.getDate()).padStart(2, '0');
            const hours = String(slot.getHours()).padStart(2, '0');
            const minutes = String(slot.getMinutes()).padStart(2, '0');
            const localISOString = `${year}-${month}-${day}T${hours}:${minutes}:00`;
            console.log("Generated slot:", localISOString);
            slots.push(localISOString);
          }
        }
      }

      availableTimes = slots;
      console.log("Available slots:", slots.length);
      timesDiv.innerHTML = "";

      if (slots.length === 0) {
        timesDiv.innerHTML = "<em>No available slots.</em>";
        return;
      }

      slots.forEach((iso) => {
        const btn = document.createElement("div");
        btn.className = "slot";
        const t = new Date(iso);
        btn.textContent = t.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        btn.dataset.time = iso;
        btn.onclick = () => {
          document.querySelectorAll(".slot").forEach((el) => el.classList.remove("selected"));
          btn.classList.add("selected");
          selectedTimeInput.value = iso;
        };
        timesDiv.appendChild(btn);
      });
    });

    document.getElementById("booking-form").addEventListener("submit", function (e) {
      const selected = selectedTimeInput.value;
      if (!selected || !availableTimes.includes(selected)) {
        alert("Please select a valid future time slot.");
        e.preventDefault();
      }
    });
  </script>
</body>
</html>